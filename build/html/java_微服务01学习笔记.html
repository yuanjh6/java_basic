

<!DOCTYPE html>
<html class="writer-html4" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>java_微服务01学习笔记 &mdash; java基础 v1.0 documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="java_mybatis学习要点" href="java_mybatis学习要点.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home" alt="Documentation Home"> java基础
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="java_读书01guide学习笔记.html">java_读书01guide学习笔记</a></li>
<li class="toctree-l1"><a class="reference internal" href="java_读书02java核心面试知识整理.html">java_读书02java核心面试知识整理</a></li>
<li class="toctree-l1"><a class="reference internal" href="java_读书03Java基础高频面试题(2021年最新版).html">java_读书03Java基础高频面试题(2021年最新版)</a></li>
<li class="toctree-l1"><a class="reference internal" href="java_读书05殷建卫架构笔记之java.html">java_读书05殷建卫架构笔记之java</a></li>
<li class="toctree-l1"><a class="reference internal" href="java_基础01常见坑.html">java_基础01常见坑</a></li>
<li class="toctree-l1"><a class="reference internal" href="java_基础02集合.html">java_基础02集合</a></li>
<li class="toctree-l1"><a class="reference internal" href="java_基础03双亲委派.html">java_基础03双亲委派</a></li>
<li class="toctree-l1"><a class="reference internal" href="java_基础04内存结构和gc垃圾回收.html">java_基础04内存结构和gc垃圾回收</a></li>
<li class="toctree-l1"><a class="reference internal" href="java_并发编程01JMM内存模型.html">java_并发编程01JMM内存模型</a></li>
<li class="toctree-l1"><a class="reference internal" href="java_并发编程02Volatile.html">java_并发编程02Volatile</a></li>
<li class="toctree-l1"><a class="reference internal" href="java_并发编程03Atomic原子类和CAS.html">java_并发编程03Atomic原子类和CAS</a></li>
<li class="toctree-l1"><a class="reference internal" href="java_并发编程04Synchronized.html">java_并发编程04Synchronized</a></li>
<li class="toctree-l1"><a class="reference internal" href="java_并发编程05从锁到ReentrantLock.html">java_并发编程05从锁到ReentrantLock</a></li>
<li class="toctree-l1"><a class="reference internal" href="java_并发编程06从ReentrantLock到AQS.html">java_并发编程06从ReentrantLock到AQS</a></li>
<li class="toctree-l1"><a class="reference internal" href="java_并发编程07锁相关小结.html">java_并发编程07锁相关小结</a></li>
<li class="toctree-l1"><a class="reference internal" href="java_并发编程08CyclicBarrier_CountDownLatch_Semaphore.html">java_并发编程08CyclicBarrier_CountDownLatch_Semaphore</a></li>
<li class="toctree-l1"><a class="reference internal" href="java_并发编程09ThreadLocal.html">java_并发编程09ThreadLocal</a></li>
<li class="toctree-l1"><a class="reference internal" href="java_并发编程10阻塞队列.html">java_并发编程10阻塞队列</a></li>
<li class="toctree-l1"><a class="reference internal" href="java_并发编程11线程池.html">java_并发编程11线程池</a></li>
<li class="toctree-l1"><a class="reference internal" href="java_spring01读书要点.html">java_spring01读书要点</a></li>
<li class="toctree-l1"><a class="reference internal" href="java_spring02ioc有什么优点.html">java_spring02ioc有什么优点</a></li>
<li class="toctree-l1"><a class="reference internal" href="java_spring03依赖注入与自动装配区别.html">java_spring03依赖注入与自动装配区别</a></li>
<li class="toctree-l1"><a class="reference internal" href="java_spring04Autowired与Resource差异解析.html">java_spring04Autowired与Resource差异解析</a></li>
<li class="toctree-l1"><a class="reference internal" href="java_spring05循环依赖.html">java_spring05循环依赖</a></li>
<li class="toctree-l1"><a class="reference internal" href="java_mybatis学习要点.html">java_mybatis学习要点</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">java_微服务01学习笔记</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#id1">01-开篇</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id2">02-构建分布式应用</a></li>
<li class="toctree-l2"><a class="reference internal" href="#spring-boot-actuator">03-监控：强大的Spring Boot Actuator</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id3">04-服务注册与服务发现-原理剖析</a></li>
<li class="toctree-l2"><a class="reference internal" href="#eureka">05-服务注册与服务发现-Eureka入门</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id4">06-服务注册与服务发现-Eureka深入</a></li>
<li class="toctree-l2"><a class="reference internal" href="#ribbon">07-Ribbon入门</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id5">08-Ribbon深入</a></li>
<li class="toctree-l2"><a class="reference internal" href="#feign">09-Feign</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id6">10-Feign深入</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id7">11-Feign常见问题总结</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id8">12-微服务容错三板斧</a></li>
<li class="toctree-l2"><a class="reference internal" href="#hystrix">13-通用方式使用Hystrix</a></li>
<li class="toctree-l2"><a class="reference internal" href="#feignhystrix">14-Feign使用Hystrix</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id9">15-Hystrix监控详解</a></li>
<li class="toctree-l2"><a class="reference internal" href="#zuul">16-Zuul</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id10">17-Zuul路由配置详解</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id11">18-Zuul深入</a></li>
<li class="toctree-l2"><a class="reference internal" href="#spring-cloud-config">19-配置中心-Spring Cloud Config</a></li>
<li class="toctree-l2"><a class="reference internal" href="#spring-cloud-config-git">20-Spring Cloud Config-Git仓库配置详解</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id12">21-Spring Cloud Config-配置属性加解密</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id13">22-Spring Cloud Config-配置动态刷新</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id14">23-Spring Cloud Config高可用</a></li>
<li class="toctree-l2"><a class="reference internal" href="#spring-cloud-sleuth">24-Spring Cloud Sleuth入门</a></li>
<li class="toctree-l2"><a class="reference internal" href="#spring-cloud-sleuthzipkin">25-Spring Cloud Sleuth与Zipkin配合使用</a></li>
<li class="toctree-l2"><a class="reference internal" href="#elasticsearchzipkin-server">26-使用Elasticsearch作为Zipkin Server的后端存储</a></li>
</ul>
</li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">java基础</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>java_微服务01学习笔记</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/java_微服务01学习笔记.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="java-01">
<h1>java_微服务01学习笔记<a class="headerlink" href="#java-01" title="Permalink to this headline">¶</a></h1>
<p>教程地址:跟我学Spring Cloud（Finchley版）</p>
<p>Spring Cloud系列教程：www.itmuch.com/spring-cloud/spring-cloud-index/#一、跟我学Spring-Cloud系列</p>
<div class="section" id="id1">
<h2>01-开篇<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="id2">
<h2>02-构建分布式应用<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p>Spring Boot/Spring Cloud时代后，应用开发基本遵循三板斧：</p>
<p>加依赖</p>
<p>加注解</p>
<p>写配置</p>
<p>创建Pom.xml</p>
<p>创建实体类</p>
<p>创建DAO：</p>
<p>创建Controller：</p>
<p>编写启动类：</p>
<p>ApplicationRunner init(UserRepository repository) 初始化了三条数据，</p>
<p>编写配置文件application.yml</p>
</div>
<div class="section" id="spring-boot-actuator">
<h2>03-监控：强大的Spring Boot Actuator<a class="headerlink" href="#spring-boot-actuator" title="Permalink to this headline">¶</a></h2>
<p>加依赖：actuator</p>
<p>加配置：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">management</span><span class="p">:</span>
  <span class="n">endpoint</span><span class="p">:</span>
    <span class="n">health</span><span class="p">:</span>
      <span class="c1"># 是否展示健康检查详情</span>
      <span class="n">show</span><span class="o">-</span><span class="n">details</span><span class="p">:</span> <span class="n">always</span>
</pre></div>
</div>
</div>
<div class="section" id="id3">
<h2>04-服务注册与服务发现-原理剖析<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<p>服务发现组件应具备以下功能。</p>
<p>服务注册表：服务注册表是服务发现组件的核心（其实就是类似于上面的registry表），它用来记录各个微服务的信息，例如微服务的名称、IP、端口等。服务注册表提供查询API和管理API，查询API用于查询可用的微服务实例，管理API用于服务的注册和注销；</p>
<p>服务注册与服务发现：服务注册是指微服务在启动时，将自己的信息注册到服务发现组件上的过程。服务发现是指查询可用微服务列表及其网络地址的机制；</p>
<p>服务检查：服务发现组件使用一定机制定时检测已注册的服务，如发现某实例长时间无法访问，就会从服务注册表中移除该实例。</p>
</div>
<div class="section" id="eureka">
<h2>05-服务注册与服务发现-Eureka入门<a class="headerlink" href="#eureka" title="Permalink to this headline">¶</a></h2>
<p>Eureka是Netflix开源的服务发现组件，本身是一个基于REST的服务，包含Server和Client两部分，Spring Cloud将它集成在子项目Spring Cloud Netflix中。</p>
<p><strong>编写Eureka Server</strong>：加依赖，加注解，写配置</p>
<p>依赖：spring-cloud-starter-netflix-eureka-server</p>
<p>注解:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@SpringBootApplication</span>
<span class="nd">@EnableEurekaServer</span>
<span class="n">public</span> <span class="k">class</span> <span class="nc">EurekaApplication</span> <span class="p">{</span>
  <span class="n">public</span> <span class="n">static</span> <span class="n">void</span> <span class="n">main</span><span class="p">(</span><span class="n">String</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">SpringApplication</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">EurekaApplication</span><span class="o">.</span><span class="n">class</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>配置：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">server</span><span class="p">:</span>
  <span class="n">port</span><span class="p">:</span> <span class="mi">8761</span>
<span class="n">eureka</span><span class="p">:</span>
  <span class="n">client</span><span class="p">:</span>
    <span class="c1"># 是否要注册到其他Eureka Server实例</span>
    <span class="n">register</span><span class="o">-</span><span class="k">with</span><span class="o">-</span><span class="n">eureka</span><span class="p">:</span> <span class="n">false</span>
    <span class="c1"># 是否要从其他Eureka Server实例获取数据</span>
    <span class="n">fetch</span><span class="o">-</span><span class="n">registry</span><span class="p">:</span> <span class="n">false</span>
    <span class="n">service</span><span class="o">-</span><span class="n">url</span><span class="p">:</span> 
      <span class="n">defaultZone</span><span class="p">:</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">8761</span><span class="o">/</span><span class="n">eureka</span><span class="o">/</span>
</pre></div>
</div>
<p><strong>将应用注册到Eureka Server上</strong>：加依赖，加注解，写配置</p>
<p>依赖：spring-cloud-starter-netflix-eureka-client</p>
<p>注解：此处无变化。早期的版本（Dalston及更早版本）还需在启动类上添加注解&#64;EnableDiscoveryClient 或&#64;EnableEurekaClient ，从Edgware开始，该注解可省略。</p>
<p>配置:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">spring</span><span class="p">:</span>
  <span class="n">application</span><span class="p">:</span>
    <span class="c1"># 指定注册到eureka server上的服务名称，对于电影微服务，本系列将名称设为microservice-consumer-movie</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">microservice</span><span class="o">-</span><span class="n">provider</span><span class="o">-</span><span class="n">user</span>
<span class="n">eureka</span><span class="p">:</span>
  <span class="n">client</span><span class="p">:</span>
    <span class="n">service</span><span class="o">-</span><span class="n">url</span><span class="p">:</span>
      <span class="c1"># 指定eureka server通信地址，注意/eureka/小尾巴不能少</span>
      <span class="n">defaultZone</span><span class="p">:</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">8761</span><span class="o">/</span><span class="n">eureka</span><span class="o">/</span>
  <span class="n">instance</span><span class="p">:</span>
    <span class="c1"># 是否注册IP到eureka server，如不指定或设为false，那就会注册主机名到eureka server</span>
    <span class="n">prefer</span><span class="o">-</span><span class="n">ip</span><span class="o">-</span><span class="n">address</span><span class="p">:</span> <span class="n">true</span>
</pre></div>
</div>
</div>
<div class="section" id="id4">
<h2>06-服务注册与服务发现-Eureka深入<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h2>
<p><strong>Region &amp; Availability Zone</strong></p>
<p>Region表示AWS中的地理位置，例如us-east-1、us-east-2、eu-west-1等；</p>
<p>每个Region都有多个Availability Zone，彼此内网打通；</p>
<p>各个Region之间完全隔离，彼此内网不打通；</p>
<p>AWS通过这种方式实现了最大的容错和稳定性。</p>
<p>Spring Cloud中，默认使用的Region是us-east-1 。非AWS环境下，可将将Region理解为内网没有打通的机房，将Availability Zone理解成相同机房的不同机架（内网打通）。</p>
<p><img alt="_images/20210110170635666_468128798.png" src="_images/20210110170635666_468128798.png" /></p>
<p><strong>Eureka包含两个组件：Eureka Server 和 Eureka Client</strong>，它们的作用如下：</p>
<p>Eureka Server提供服务发现的能力，各个微服务启动时，会向Eureka Server注册自己的信息（例如IP、端口、微服务名称等），Eureka Server会存储这些信息；
Eureka Client是一个Java客户端，用于简化与Eureka Server的交互；</p>
<p>微服务启动后，会周期性（默认30秒）地<strong>向Eureka Server发送心跳</strong>以续约自己的“租期”；</p>
<p>如果Eureka Server在一定时间内没有接收到某个微服务实例的心跳，Eureka Server将会<strong>注销该实例（默认90秒）</strong>；</p>
<p>默认情况下，Eureka Server同时也是Eureka Client。<strong>多个Eureka Server实例，互相之间通过增量复制的方式，来实现服务注册表中数据的同步</strong>。Eureka Server默认保证在90秒内，Eureka Server集群内的所有实例中的数据达到一致（从这个架构来看，Eureka Server所有实例所处的角色都是对等的，没有类似Zookeeper、Consul、Etcd等软件的选举过程，也不存在主从，所有的节点都是主节点。Eureka官方将Eureka Server集群中的所有实例称为“对等体（peer）”）</p>
<p><strong>Eureka Client会缓存服务注册表中的信息</strong>。这种方式有一定的优势——首先，微服务无需每次请求都查询Eureka Server，从而<strong>降低了Eureka Server的压力</strong>；其次，即使<strong>Eureka Server所有节点都宕掉</strong>，服务消费者依然可以使用缓存中的信息找到服务提供者并完成调用。</p>
<p>综上，<strong>Eureka通过心跳检查、客户端缓存等机制</strong>，提高了系统的灵活性、可伸缩性和可用性。</p>
<p><strong>编写高可用Eureka Server</strong></p>
<p>下面来编写一个双节点Eureka Server集群。编写这个集群非常简单，只需修改单实例Eureka Server的配置即可：</p>
<p>修改vim /etc/hosts：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># 添加如下内容</span>
<span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span> <span class="n">peer1</span> <span class="n">peer2</span>
</pre></div>
</div>
<p>配置:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">spring</span><span class="p">:</span>
  <span class="n">application</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">microservice</span><span class="o">-</span><span class="n">discovery</span><span class="o">-</span><span class="n">eureka</span><span class="o">-</span><span class="n">ha</span>
<span class="o">---</span>
<span class="n">spring</span><span class="p">:</span>
  <span class="n">profiles</span><span class="p">:</span> <span class="n">peer1</span>                                 <span class="c1"># 指定profile=peer1</span>
<span class="n">server</span><span class="p">:</span>
  <span class="n">port</span><span class="p">:</span> <span class="mi">8761</span>
<span class="n">eureka</span><span class="p">:</span>
  <span class="n">instance</span><span class="p">:</span>
    <span class="n">hostname</span><span class="p">:</span> <span class="n">peer1</span>                               <span class="c1"># 指定当profile=peer1时，主机名是peer1</span>
  <span class="n">client</span><span class="p">:</span>
    <span class="n">serviceUrl</span><span class="p">:</span>
      <span class="n">defaultZone</span><span class="p">:</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">peer2</span><span class="p">:</span><span class="mi">8762</span><span class="o">/</span><span class="n">eureka</span><span class="o">/</span>      <span class="c1"># 将自己注册到peer2这个Eureka上面去</span>
<span class="o">---</span>
<span class="n">spring</span><span class="p">:</span>
  <span class="n">profiles</span><span class="p">:</span> <span class="n">peer2</span>
<span class="n">server</span><span class="p">:</span>
  <span class="n">port</span><span class="p">:</span> <span class="mi">8762</span>
<span class="n">eureka</span><span class="p">:</span>
  <span class="n">instance</span><span class="p">:</span>
    <span class="n">hostname</span><span class="p">:</span> <span class="n">peer2</span>
  <span class="n">client</span><span class="p">:</span>
    <span class="n">serviceUrl</span><span class="p">:</span>
      <span class="n">defaultZone</span><span class="p">:</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">peer1</span><span class="p">:</span><span class="mi">8761</span><span class="o">/</span><span class="n">eureka</span><span class="o">/</span>
</pre></div>
</div>
<p>如果两个Eureka Server实例在同一台机器上启动，那么配置hosts的这一步不能少。原因：<strong>Eureka Server对端口是不敏感的</strong>，这意味着，如果直接用IP的形式（例如地址写成http://127.0.0.1:8761/eureka/）相互注册，Eureka Server误认为两个Eureka Server实例是一个实例——这会造成Eureka Server首页显示不正常等一系列问题！！</p>
<p>编写Eureka Server集群的简写方式：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">spring</span><span class="p">:</span>
  <span class="n">application</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">microservice</span><span class="o">-</span><span class="n">discovery</span><span class="o">-</span><span class="n">eureka</span><span class="o">-</span><span class="n">ha</span>
<span class="n">eureka</span><span class="p">:</span>
  <span class="n">client</span><span class="p">:</span>
    <span class="n">serviceUrl</span><span class="p">:</span>
      <span class="n">defaultZone</span><span class="p">:</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">peer2</span><span class="p">:</span><span class="mi">8762</span><span class="o">/</span><span class="n">eureka</span><span class="o">/</span><span class="p">,</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">peer1</span><span class="p">:</span><span class="mi">8761</span><span class="o">/</span><span class="n">eureka</span><span class="o">/</span>
<span class="o">---</span>
<span class="n">spring</span><span class="p">:</span>
  <span class="n">profiles</span><span class="p">:</span> <span class="n">peer1</span>
<span class="n">server</span><span class="p">:</span>
  <span class="n">port</span><span class="p">:</span> <span class="mi">8761</span>
<span class="n">eureka</span><span class="p">:</span>
  <span class="n">instance</span><span class="p">:</span>
    <span class="n">hostname</span><span class="p">:</span> <span class="n">peer1</span>
<span class="o">---</span>
<span class="n">spring</span><span class="p">:</span>
  <span class="n">profiles</span><span class="p">:</span> <span class="n">peer2</span>
<span class="n">server</span><span class="p">:</span>
  <span class="n">port</span><span class="p">:</span> <span class="mi">8762</span>
<span class="n">eureka</span><span class="p">:</span>
  <span class="n">instance</span><span class="p">:</span>
    <span class="n">hostname</span><span class="p">:</span> <span class="n">peer2</span>
</pre></div>
</div>
<p><strong>RESTful API</strong></p>
<p>举例:rest-api-test.xml</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">instance</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">instanceId</span><span class="o">&gt;</span><span class="n">itmuch</span><span class="p">:</span><span class="n">rest</span><span class="o">-</span><span class="n">api</span><span class="o">-</span><span class="n">test</span><span class="p">:</span><span class="mi">9000</span><span class="o">&lt;/</span><span class="n">instanceId</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">hostName</span><span class="o">&gt;</span><span class="n">itmuch</span><span class="o">&lt;/</span><span class="n">hostName</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">app</span><span class="o">&gt;</span><span class="n">REST</span><span class="o">-</span><span class="n">API</span><span class="o">-</span><span class="n">TEST</span><span class="o">&lt;/</span><span class="n">app</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">ipAddr</span><span class="o">&gt;</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="o">&lt;/</span><span class="n">ipAddr</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">vipAddress</span><span class="o">&gt;</span><span class="n">rest</span><span class="o">-</span><span class="n">api</span><span class="o">-</span><span class="n">test</span><span class="o">&lt;/</span><span class="n">vipAddress</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">secureVipAddress</span><span class="o">&gt;</span><span class="n">rest</span><span class="o">-</span><span class="n">api</span><span class="o">-</span><span class="n">test</span><span class="o">&lt;/</span><span class="n">secureVipAddress</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">status</span><span class="o">&gt;</span><span class="n">UP</span><span class="o">&lt;/</span><span class="n">status</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">port</span> <span class="n">enabled</span><span class="o">=</span><span class="s2">&quot;true&quot;</span><span class="o">&gt;</span><span class="mi">9000</span><span class="o">&lt;/</span><span class="n">port</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">securePort</span> <span class="n">enabled</span><span class="o">=</span><span class="s2">&quot;false&quot;</span><span class="o">&gt;</span><span class="mi">443</span><span class="o">&lt;/</span><span class="n">securePort</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">homePageUrl</span><span class="o">&gt;</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">9000</span><span class="o">/&lt;/</span><span class="n">homePageUrl</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">statusPageUrl</span><span class="o">&gt;</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">9000</span><span class="o">/</span><span class="n">info</span><span class="o">&lt;/</span><span class="n">statusPageUrl</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">healthCheckUrl</span><span class="o">&gt;</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">9000</span><span class="o">/</span><span class="n">health</span><span class="o">&lt;/</span><span class="n">healthCheckUrl</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">dataCenterInfo</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;com.netflix.appinfo.InstanceInfo$DefaultDataCenterInfo&quot;</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">name</span><span class="o">&gt;</span><span class="n">MyOwn</span><span class="o">&lt;/</span><span class="n">name</span><span class="o">&gt;</span>
  <span class="o">&lt;/</span><span class="n">dataCenterInfo</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">instance</span><span class="o">&gt;</span>
</pre></div>
</div>
<p><strong>RESTful API的意义</strong></p>
<p>你可能会问：我们不是已经有Eureka Client了吗？谁闲着没事再去用RESTful API啊？</p>
<p>要知道，微服务的优势之一就是允许使用异构的技术、异构的语言甚至异构的平台解决你想解决的问题。</p>
<p>举个例子，如果你有一个系统，一部分是Spring Cloud构建的，一部分是用世界上最好的语言PHP写的！但是呢，你希望Java应用与PHP应用之间的通信也能享受服务发现所带来的好处，此时就可编写一个基于PHP的Eureka Client，将PHP应用也注册到Eureka Server！</p>
<p>事实上，前文说的Eureka Client不过是一个用Jersey 1.x封装了RESTful API的Jar包而已。</p>
</div>
<div class="section" id="ribbon">
<h2>07-Ribbon入门<a class="headerlink" href="#ribbon" title="Permalink to this headline">¶</a></h2>
<p>依赖:加依赖：由于spring-cloud-starter-netflix-eureka-client 已经包含spring-cloud-starter-netfilx-ribbon ，故而无需额外添加依赖。
注解：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@Bean</span>
<span class="nd">@LoadBalanced</span>
<span class="n">public</span> <span class="n">RestTemplate</span> <span class="n">restTemplate</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">new</span> <span class="n">RestTemplate</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<p>调用:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@GetMapping</span><span class="p">(</span><span class="s2">&quot;/users/</span><span class="si">{id}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">public</span> <span class="n">User</span> <span class="n">findById</span><span class="p">(</span><span class="nd">@PathVariable</span> <span class="n">Long</span> <span class="nb">id</span><span class="p">)</span> <span class="p">{</span>
  <span class="o">//</span> <span class="n">这里用到了RestTemplate的占位符能力</span>
  <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">this</span><span class="o">.</span><span class="n">restTemplate</span><span class="o">.</span><span class="n">getForObject</span><span class="p">(</span>
    <span class="s2">&quot;http://microservice-provider-user/users/</span><span class="si">{id}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="n">User</span><span class="o">.</span><span class="n">class</span><span class="p">,</span>
    <span class="nb">id</span>
  <span class="p">);</span>
  <span class="o">//</span> <span class="o">...</span><span class="n">电影微服务的业务</span><span class="o">...</span>
  <span class="k">return</span> <span class="n">user</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>将请求的目标服务改成了http://microservice-provider-user/users/{id} ，也就是http://{目标服务名称}/{目标服务端点} 的形式，Ribbon会自动在实际调用时，将目标服务名替换为该服务的IP和端口。</p>
<p>原来: this.restTemplate.getForObject(“http://localhost:8000/users/{id}”, User.class, id);</p>
<p>这里的目标服务名称，在Ribbon里叫虚拟主机名 ，主机名是不能包含_ 等特殊字符的——这意味着，一般不建议配置spring.application.name = xxx_xxx</p>
</div>
<div class="section" id="id5">
<h2>08-Ribbon深入<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h2>
<p>内置负载均衡规则</p>
<p>Ribbon配置自定义【细粒度配置】：</p>
<p>方式1、代码配置方式，</p>
<p>方式2、属性配置方式【推荐】</p>
<p>代码示例</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">user</span><span class="p">:</span>
  <span class="n">ribbon</span><span class="p">:</span>
    <span class="n">NFLoadBalancerRuleClassName</span><span class="p">:</span> <span class="n">com</span><span class="o">.</span><span class="n">netflix</span><span class="o">.</span><span class="n">loadbalancer</span><span class="o">.</span><span class="n">RandomRule</span>
</pre></div>
</div>
</div>
<div class="section" id="feign">
<h2>09-Feign<a class="headerlink" href="#feign" title="Permalink to this headline">¶</a></h2>
<p>取代restTemplate</p>
<p>加依赖：</p>
<p>加注解：启动类上添加&#64;EnableFeignClients ；</p>
<p>编写Feign Client</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@FeignClient</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;microservice-provider-user&quot;</span><span class="p">)</span>
<span class="n">public</span> <span class="n">interface</span> <span class="n">UserFeignClient</span> <span class="p">{</span>
  <span class="nd">@GetMapping</span><span class="p">(</span><span class="s2">&quot;/users/</span><span class="si">{id}</span><span class="s2">&quot;</span><span class="p">)</span>
  <span class="n">User</span> <span class="n">findById</span><span class="p">(</span><span class="nd">@PathVariable</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span> <span class="n">Long</span> <span class="nb">id</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>改control</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">public</span> <span class="k">class</span> <span class="nc">MovieController</span> <span class="p">{</span>
  <span class="nd">@Autowired</span>
  <span class="n">private</span> <span class="n">UserFeignClient</span> <span class="n">userFeignClient</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id6">
<h2>10-Feign深入<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="id7">
<h2>11-Feign常见问题总结<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="id8">
<h2>12-微服务容错三板斧<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h2>
<p>应用容错三板斧</p>
<p>超时机制:一旦超时，就释放资源。由于释放资源速度较快，应用就不会那么容易被拖死。</p>
<p>舱壁模式:软件世界里的仓壁模式可以这样理解：M类使用线程池1，N类使用线程池2，彼此的线程池不同，并且为每个类分配的线程池较小，</p>
<p>断路器:实时监测应用，如果发现在一定时间内失败次数/失败率达到一定阈值，就“跳闸”，断路器打开——此时，请求直接返回，而不去调用原本调用的逻辑。</p>
</div>
<div class="section" id="hystrix">
<h2>13-通用方式使用Hystrix<a class="headerlink" href="#hystrix" title="Permalink to this headline">¶</a></h2>
<p>加依赖：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">dependency</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">groupId</span><span class="o">&gt;</span><span class="n">org</span><span class="o">.</span><span class="n">springframework</span><span class="o">.</span><span class="n">cloud</span><span class="o">&lt;/</span><span class="n">groupId</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">artifactId</span><span class="o">&gt;</span><span class="n">spring</span><span class="o">-</span><span class="n">cloud</span><span class="o">-</span><span class="n">starter</span><span class="o">-</span><span class="n">netflix</span><span class="o">-</span><span class="n">hystrix</span><span class="o">&lt;/</span><span class="n">artifactId</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">dependency</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>加注解：在启动类上添加&#64;EnableCircuitBreaker 注解。</p>
<p>使用：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@HystrixCommand</span><span class="p">(</span><span class="n">fallbackMethod</span> <span class="o">=</span> <span class="s2">&quot;findByIdFallback&quot;</span><span class="p">)</span>
<span class="nd">@GetMapping</span><span class="p">(</span><span class="s2">&quot;/users/</span><span class="si">{id}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">public</span> <span class="n">User</span> <span class="n">findById</span><span class="p">(</span><span class="nd">@PathVariable</span> <span class="n">Long</span> <span class="nb">id</span><span class="p">)</span> <span class="p">{</span>
  <span class="o">//</span> <span class="n">这里用到了RestTemplate的占位符能力</span>
  <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">this</span><span class="o">.</span><span class="n">restTemplate</span><span class="o">.</span><span class="n">getForObject</span><span class="p">(</span>
    <span class="s2">&quot;http://microservice-provider-user/users/</span><span class="si">{id}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="n">User</span><span class="o">.</span><span class="n">class</span><span class="p">,</span>
    <span class="nb">id</span>
  <span class="p">);</span>
  <span class="o">//</span> <span class="o">...</span><span class="n">电影微服务的业务</span><span class="o">...</span>
  <span class="k">return</span> <span class="n">user</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">public</span> <span class="n">User</span> <span class="n">findByIdFallback</span><span class="p">(</span><span class="n">Long</span> <span class="nb">id</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">new</span> <span class="n">User</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="s2">&quot;默认用户&quot;</span><span class="p">,</span> <span class="s2">&quot;默认用户&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">new</span> <span class="n">BigDecimal</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
<span class="p">}</span>
</pre></div>
</div>
<p>由代码可知，只需使用&#64;HystrixCommand 注解，就可保护该API。这里的”保护“，其实带有三层含义——”超时机制“、”仓壁模式“、”断路器“！</p>
</div>
<div class="section" id="feignhystrix">
<h2>14-Feign使用Hystrix<a class="headerlink" href="#feignhystrix" title="Permalink to this headline">¶</a></h2>
<p>Feign默认已经整合了Hystrix，默认Feign是不启用Hystrix的，</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">feign</span><span class="p">:</span>
  <span class="n">hystrix</span><span class="p">:</span>
    <span class="n">enabled</span><span class="p">:</span> <span class="n">true</span>
</pre></div>
</div>
</div>
<div class="section" id="id9">
<h2>15-Hystrix监控详解<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h2>
<p>监控端点与数据</p>
<p>可视化监控数据</p>
<p>监控数据聚合-Turbine</p>
</div>
<div class="section" id="zuul">
<h2>16-Zuul<a class="headerlink" href="#zuul" title="Permalink to this headline">¶</a></h2>
<p>Zuul是Netflix开源的微服务网关，它可以和Eureka、Ribbon、Hystrix等组件配合使用。Zuul的核心是一系列的过滤器，这些过滤器帮助我们完成以下功能：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>身份认证与安全：识别每个资源的验证要求，并拒绝那些与要求不符的请求；
审查与监控：在边缘位置追踪有意义的数据和统计结果，从而为我们带来精确的生产视图；
动态路由：动态地将请求路由到不同的后端集群；
压力测试：逐渐增加指向集群的流量，以了解性能；
负载分配：为每一种负载类型分配对应容量，并弃用超出限定值的请求；
静态响应处理：在边缘位置直接建立部分响应，从而避免其转发到内部集群；
多区域弹性：跨越AWS Region进行请求路由，旨在实现ELB（Elastic Load Balancing）使用的多样化；以及让系统的边缘更贴近系统的使用者。
</pre></div>
</div>
<p>加依赖</p>
<p>加注解：&#64;EnableZuulProxy</p>
<p>写配置：我们编写了一个Zuul，并将其注册到了Eureka上。</p>
</div>
<div class="section" id="id10">
<h2>17-Zuul路由配置详解<a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="id11">
<h2>18-Zuul深入<a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="spring-cloud-config">
<h2>19-配置中心-Spring Cloud Config<a class="headerlink" href="#spring-cloud-config" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="spring-cloud-config-git">
<h2>20-Spring Cloud Config-Git仓库配置详解<a class="headerlink" href="#spring-cloud-config-git" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="id12">
<h2>21-Spring Cloud Config-配置属性加解密<a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="id13">
<h2>22-Spring Cloud Config-配置动态刷新<a class="headerlink" href="#id13" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="id14">
<h2>23-Spring Cloud Config高可用<a class="headerlink" href="#id14" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="spring-cloud-sleuth">
<h2>24-Spring Cloud Sleuth入门<a class="headerlink" href="#spring-cloud-sleuth" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="spring-cloud-sleuthzipkin">
<h2>25-Spring Cloud Sleuth与Zipkin配合使用<a class="headerlink" href="#spring-cloud-sleuthzipkin" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="elasticsearchzipkin-server">
<h2>26-使用Elasticsearch作为Zipkin Server的后端存储<a class="headerlink" href="#elasticsearchzipkin-server" title="Permalink to this headline">¶</a></h2>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
      
        <a href="java_mybatis学习要点.html" class="btn btn-neutral float-left" title="java_mybatis学习要点" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2021, yuanjh

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>